var parsedData;
var pricedata;

FB.init({
    appId: "443781919115183",
    status: true,
    cookie: true
});

/*
var handlepagination = function(){
    alert('pagination button clicked...');
};
*/

var shareFB = function () {

    // alert('Facebook....');
    FB.ui(
            {
                method: 'feed',
                name: parsedData['item_' + itemnum].basicInfo.title,
                picture: parsedData['item_' + itemnum].basicInfo.galleryURL,
                link: parsedData['item_' + itemnum].basicInfo.viewItemURL,
                redirect_uri: parsedData['item_' + itemnum].basicInfo.viewItemURL,
                description: "Price: $" + pricedata + ", Location: " + parsedData['item_' + itemnum].basicInfo.location,
            },

            function (response) {
                if (response && response.post_id) {
                    alert('Posted successfully');
                }
                else {
                    alert('Not posted');
                }
            }
        );
};

$.validator.addMethod("greaterThan",
function (value, element, param) {
    var $min = $(param);
    if (this.settings.onfocusout) {
        $min.off(".validate-greaterThan").on("blur.validate-greaterThan", function () {
            $(element).valid();
        });
    }
    return parseInt(value) > parseInt($min.val());
}, "Must be greater than to field 1");


function getData(form) {
    var keywords = form[0].value;
    var minprice = form[1].value;
    var maxprice = form[2].value;
    var isnew = ($('#new').is(":checked"));
    var isused = ($('#used').is(":checked"));
    var isverygood = ($('#verygood').is(":checked"));
    var isgood = ($('#good').is(":checked"));
    var isacceptable = ($('#acceptable').is(":checked"));
    var isbuyitnow = ($('#butitnow').is(":checked"));
    var isauction = ($('#auction').is(":checked"));
    var isclassifiedads = ($('#classifiedads').is(":checked"));
    var isreturnaccepted = ($('#returnaccepted').is(":checked"));
    var isfreeshipping = ($('#freeshipping').is(":checked"));
    var isexpeditedshipping = ($('#expeditedshipping').is(":checked"));
    var handlingtime = form[14].value;
    var sortby = form[15].value;
    var resultsperpage = form[16].value;
    var pagenumber = 1;

    $.ajax({

        url: "http://cs-server.usc.edu:30833/index.php",
        // url: "http://ybaws-env.elasticbeanstalk.com",
        type: 'POST',
        data:
        {
            "keywords": keywords,
            "minprice": minprice,
            "maxprice": maxprice,
            "isnew": isnew,
            "isused": isused,
            "isverygood": isverygood,
            "isgood": isgood,
            "isacceptable": isacceptable,
            "isbuyitnow": isbuyitnow,
            "isauction": isauction,
            "isclassifiedads": isclassifiedads,
            "isreturnaccepted": isreturnaccepted,
            "isfreeshipping": isfreeshipping,
            "isexpeditedshipping": isexpeditedshipping,
            "handlingtime": handlingtime,
            "sortby": sortby,
            "resultsperpage": resultsperpage,
            "pagenumber": pagenumber
        },
        success: function (data) {
            // parse json result
            parsedData = JSON.parse(data);

            // Modal data
            /*
            $("#myModal").modal('show');
            $('#modaltitle').html(parsedData.item_0.basicInfo.title);
            $('#fullsizeimage').html("<img src=" + parsedData.item_0.basicInfo.pictureURLSuperSize + ">");
            */
            $('#resultTitle').html("1-5 items out of " + parsedData.resultCount);



            // html string for item info table
            iteminfotable = "";

            itemnum = 0;

            // Need to loop over here


            // item-1
            for (var itemnum = 0; itemnum < resultsperpage; itemnum++) {
                iteminfotable += "<div class=\"well bs-component\">";
                iteminfotable += "<table>";
                iteminfotable += "<tr>";
                iteminfotable += "<td>";
                iteminfotable += "<div class=\"col-lg-6\"><img src=" + parsedData['item_' + itemnum].basicInfo.galleryURL + "></div>";
                iteminfotable += "</td>";

                iteminfotable += "<td>";
                iteminfotable += "<h4><a href=" + "\"" + parsedData['item_' + itemnum].basicInfo.viewItemURL + "\"" + ">" + parsedData['item_' + itemnum].basicInfo.title + "</a></h4><br>";


                if (parseInt(parsedData['item_' + itemnum].basicInfo.shippingServiceCost) == 0)
                    pricedata = parsedData['item_' + itemnum].basicInfo.convertedCurrentPrice + " (FREE Shipping)";
                else
                    pricedata = parsedData['item_' + itemnum].basicInfo.convertedCurrentPrice;


                iteminfotable += "<div class=\"col-lg-6\"><b>Price: $" + pricedata + "</b></div>";
                iteminfotable += "<div class=\"col-lg-3\"><i>Location: " + parsedData['item_' + itemnum].basicInfo.location + "</i></div>";

                /* TODO: Add this later, to rated image
                if (parsedData['item_' + itemnum].basicInfo.topRatedListing === "true")
                    $('#topratedimg').html("<img src=\"itemTopRated.jpg\" width=30 height=30>");
                */

                iteminfotable += "<div class=\"col-lg-3\"><a data-toggle=\"collapse\" data-target=\"#demo" + itemnum + "\">View Details</a></div>";
                //iteminfotable += "<div class=\"col-lg-3\"><img src=\"fb.png\" height=\"30\" size=\"30\" alt=\"Facebook\" onclick=\"shareFB()\"";


                iteminfotable += "<div id=\"demo" + itemnum + "\" class=\"collapse\">";
                iteminfotable += "<div class=\"container\">";

                iteminfotable += "<ul class=\"nav nav-tabs\">";
                iteminfotable += "<li class=\"nav active\"><a href=\"#basicinfo" + itemnum + "\" data-toggle=\"tab\">Basic Info</a></li>";
                iteminfotable += "<li class=\"nav\"><a href=\"#sellerinfo" + itemnum + "\" data-toggle=\"tab\">Seller Info</a></li>";
                iteminfotable += "<li class=\"nav\"><a href=\"#shippinginfotab" + itemnum + "\" data-toggle=\"tab\">Shipping Info</a></li>";
                iteminfotable += "</ul>";

                iteminfotable += "<div class=\"tab-content\">";

                iteminfotable += "<div class=\"tab-pane fade in active\" id=\"basicinfo" + itemnum + "\">";
                iteminfotable += "<div class=\"col-lg-2\"><b>Category name</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].basicInfo.categoryName + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Condition</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].basicInfo.conditionDisplayName + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Buying format</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].basicInfo.listingType + "</div><br>";
                iteminfotable += "</div>";

                iteminfotable += "<div class=\"tab-pane fade\" id=\"sellerinfo" + itemnum + "\">";
                iteminfotable += "<div class=\"col-lg-2\"><b>User name</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].sellerInfo.sellerUserName + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Feedback score</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].sellerInfo.feedbackScore + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Positive feedback</b></div>";
                iteminfotable += " <div class=\"col-lg-2\">" + parsedData['item_' + itemnum].sellerInfo.positiveFeedbackPercent + "%</div><br>";

                iteminfotable += "<div class=\"col-lg-2\"><b>Feedback rating</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].sellerInfo.feedbackRatingStar + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Top rated</b></div>";


                if (parsedData['item_' + itemnum].sellerInfo.topRatedSeller === "true")
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-ok\" style=\"color:green\"></div><br>";
                else
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-remove\" style=\"color:red\"></div><br>";

                iteminfotable += "<div class=\"col-lg-2\"><b>Store</b></div>";


                if (parsedData['item_' + itemnum].sellerInfo.sellerStoreName === "")
                    iteminfotable += "<div class=\"col-lg-2\">N/A</div>";
                else
                    iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].sellerInfo.sellerStoreName + "</div>";
                // TODO : add seller URL
                iteminfotable += "</div>";

                iteminfotable += "<div class=\"tab-pane fade\" id=\"shippinginfotab" + itemnum + "\">";
                iteminfotable += "<div class=\"col-lg-2\"><b>Shipping type</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].shippingInfo.shippingType + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Handling time</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].shippingInfo.handlingTime + "day(s)</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Shipping locations</b></div>";
                iteminfotable += "<div class=\"col-lg-2\">" + parsedData['item_' + itemnum].shippingInfo.shipToLocations + "</div><br>";
                iteminfotable += "<div class=\"col-lg-2\"><b>Expedited shipping</b></div>";
                if (parsedData['item_' + itemnum].shippingInfo.expeditedShipping === "true")
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-ok\" style=\"color:green\"></div><br>";
                else
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-remove\" style=\"color:red\"></div><br>";

                iteminfotable += "<div class=\"col-lg-2\"><b>One day shipping</b></div>";
                if (parsedData['item_' + itemnum].shippingInfo.oneDayShippingAvailable === "true")
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-ok\" style=\"color:green\"></div><br>";
                else
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-remove\" style=\"color:red\"></div><br>";

                iteminfotable += "<div class=\"col-lg-2\"><b>Returns accepted</b></div>";
                if (parsedData['item_' + itemnum].shippingInfo.returnsAccepted === "true")
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-ok\" style=\"color:green\"></div>";
                else
                    iteminfotable += "<div class=\"col-lg-2\"><span class=\"glyphicon glyphicon-remove\" style=\"color:red\"></div>";

                iteminfotable += "</div>";
                iteminfotable += "</div>";
                iteminfotable += "</div>";
                iteminfotable += "</div>";
                iteminfotable += "</td>";
                iteminfotable += "</tr>";
                iteminfotable += "</table>";
                iteminfotable += "</div>";
            }
            $('#iteminfotable').html(iteminfotable);
            return parsedData.resultCount;
        }
    });
}


function pageClick(number) {
    alert(number);

    /*
    var data = $('#search-form').serialize();
    refreshSearchResults(data);

    paginate();
    e.preventDefault();
    e.stopPropagation();
    */
}

$(function () {



    $("#ebayshopping").submit(function (e) {
        e.preventDefault();
    }).validate({

        rules:
        {
            keywords:
            {
                required: true
            },
            minprice:
            {
                number: true,
                min: 0
            },
            maxprice:
            {
                number: true,
                greaterThan: '#minprice'
            },
            maxhandlingtime:
            {
                digits: true,
                min: 1
            }
        },

        messages: {
            keywords:
            {
                required: "Please enter a key word",
            },
            minprice:
            {
                number: "Price should be a valid number",
                min: "Minimum price cannot be below 0"
            },
            maxprice:
            {
                digits: "Price should be a valid number",
                greaterThan: "Maximum price cannot be less than minimum price"
            },
            maxhandlingtime:
            {
                digits: "Max handling time should be a valid digit",
                min: "Max handling time should be greater than or equal to 1"
            }
        },

        submitHandler: function (form) {
            // Extract form fields

            // Pagination
            var resultCount = getData(form);

            var numberOfPages = resultCount / resultsperpage < 5 ? resultCount / resultsperpage : 5;
            pageinfotable = "";
            pageinfotable += "<div class=\"text-center\">";
            pageinfotable += "<ul class=\"pagination pagination-lg\">";
            pageinfotable += "<li class=\"disabled\"><a href=\"#\">&laquo;</a></li>";
            for (var i = 0; i < numberOfPages ; i++) {
                pageinfotable += "<li><a href=\"#\" onclick=\"pageClick(" + i + ")\">" + i + "</a></li>";
            }
            pageinfotable += "<li><a href=\"#\">&raquo;</a></li>";
            pageinfotable += "</ul>";
            pageinfotable += "</div>";





        },
        error: function (jqxhr, textStatus, errorMessage) {
            alert('error');
            //console.log(argument);
        }

    });

});

